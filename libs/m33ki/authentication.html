<!DOCTYPE html>


<html>
<head>
  <title>Documentation for m33ki.authentication</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      color: #333;
      background-color: #fff;
      border-color: #999999;
      border-width: 2px;
      line-height: 1.5;
      margin: 2em 3em;
      text-align: left;
      padding: 0 100px 0 100px;
    }
    pre {
      background-color: #eee;
      padding: 10px;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      overflow: auto;
    }
    code {
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 80%;
      background-color: #eee;
      padding: 1px 3px;
      -webkit-border-radius: 2px;
      -moz-border-radius: 2px;
      border-radius: 2px;
    }
    pre code {
      padding-left: 0px;
      padding-right: 0px;
    }
    li p {
      margin: 0.3em;
    }
    ul > li {
      list-style-type: disc;
    }
    a:link, a:visited {
      color: #33e;
      text-decoration: none;
    }
    a:hover {
      color: #00f;
      text-decoration:underline;
    }
    h1 {
      color: #999;
      font-weight: 400;
      font-size: 36px;
    }
    h2 {
      border-bottom: 1px dotted #aaa;
      margin-bottom: 1em;
      color: #333;
      font-size: 30px;
    }
    h3 {
      color: #666;
      font-size: 24px;
    }
    h4 {
      font-size: 21px;
    }
    h5 {
      font-size: 18px;
    }
  </style>
</head>
<body>

<h1>Documentation for m33ki.authentication</h1>
<div>
  
</div>


<h2>Functions</h2>

  <h3>ADMIN(users, securityKey)</h3>
  <div>
    <h4>Description</h4>
<p><code>ADMIN()</code> function is a quick helper to get REST routes about users management. It works with memory collections (<code>m33ki.collections.Collection()</code>) and MongoDb collections (<code>m33ki.mongodb.MongoCollection(MongoModel)</code>).</p>
<h4>Parameters</h4>
<ul>
<li><code>users</code> : this is a <code>m33ki.collections.Collection()</code>. It can mixin a <code>m33ki.mongodb.MongoCollection(MongoModel)</code></li>
<li><code>securityKey</code> : allow encrypt/decrypt user password</li>
</ul>
<h4>Routes</h4>
<ul>
<li>Create user : this is a <code>POST</code> request : <code>/users</code>, you have to be login as admin</li>
<li>Retrieve all users : this is a <code>GET</code> request : <code>/users</code>, you have to be login as admin</li>
<li>Retrieve a user by id : this is a <code>GET</code> request : <code>/users/:id</code>, you have to be login as admin</li>
<li>Retrieve a user by pseudo : this is a <code>GET</code> request : <code>/users/pseudo/:pseudo</code>, you have to be login as admin</li>
<li><strong>(WIP:TO BE TESTED)</strong> Update a user by id : this is a <code>PUT</code> request : <code>/users/:id</code>, you have to be login as admin</li>
<li>Delete a user by id : this is a <code>DELETE</code> request : <code>/users/:id</code>, you have to be login as admin</li>
</ul>
<h4>Calling Admin Routes with jQuery (<code>$.ajax</code>)</h4>
<h5>Create a user :</h5>
<pre><code>$.ajax({
  type: "POST",
  url: "users",
  data: JSON.stringify({
      pseudo        : "phil"
    ,   password    : "phil"
    ,   create      : true
    ,   read        : true
    ,   update      : true
    ,   delete      : true
    ,   admin       : false
  }),
  success: function(data){ console.log("success", data); },
  error: function(err){ console.log("error", err); },
  dataType: "json"
});
</code></pre>
<h5>Get all users :</h5>
<pre><code>$.ajax({
  type: "GET",
  url: "users",
  success: function(users){ console.log(users) }
});
</code></pre>
<h5>Get a user by pseudo :</h5>
<pre><code>$.ajax({
  type: "GET",
  url: "users/pseudo/phil",
  success: function(human){ console.log(human) }
});
</code></pre>
<h5>Update a user (you need id of user):</h5>
<pre><code>$.ajax({
  type: "PUT",
  url: "users/52b6baaa3004530ace382ae1",
  data: JSON.stringify({
      pseudo        : "phil"
    ,   password    : "philip"
    ,   create      : true
    ,   read        : true
    ,   update      : true
    ,   delete      : true
    ,   admin       : true
  }),
  success: function(data){ console.log("success", data); },
  error: function(err){ console.log("error", err); },
  dataType: "json"
});
</code></pre>
<h5>Delete a user (you need id of user):</h5>
<pre><code>$.ajax({
  type: "DELETE",
  url: "users/52b6baaa3004530ace382ae1",
  success: function(message){ console.log(message) }
});
</code></pre>

  </div>

  <h3>AUTHENTICATION(users, securityKey, onLogin, onLogout, ifAuthenticated)</h3>
  <div>
    <h4>Description</h4>
<p><code>AUTHENTICATION()</code> method is a helper about users authentication. It creates necessary REST routes about :</p>
<ul>
<li>user login</li>
<li>user logout</li>
<li>authentication user checking</li>
</ul>
<h4>Parameters</h4>
<ul>
<li><code>users</code> : this is a <code>m33ki.collections.Collection()</code>. It can mixin a <code>m33ki.mongodb.MongoCollection(MongoModel)</code></li>
<li><code>securityKey</code> : allow encrypt/decrypt user password</li>
<li><code>onLogin</code> : callback on user login : passing parameter : <code>user Model()</code> and <code>authenticated</code> (<code>true</code> or <code>false</code>)</li>
<li><code>onLogout</code> : callback on user logout : passing parameters : <code>user_id</code>, <code>user_pseudo</code></li>
<li><code>ifAuthenticated</code> : callback on authentication checking : passing parameters : <code>user_id</code>, <code>user_pseudo</code> | <code>null</code> and <code>null</code> if failed</li>
</ul>
<h4>Snippet</h4>
<pre><code>AUTHENTICATION(
    AppUsers()
  , getSecurityKey()
  , |user, authenticated| { # on LogIn
      println(user: getField("pseudo") + " is authenticated : " + authenticated)
    }
  , |id, pseudo| { # on LogOut
      println(pseudo + "[" + id +  "] is gone ...")
    }
  , |id, pseudo| { # Authentication checking
      if id isnt null {
        println(pseudo +  " is online and authenticated ...")
      } else {
        println("Current user isn't authenticated ...")
      }
    }
)
</code></pre>
<h4>Routes</h4>
<p>If you're using <code>AUTHENTICATION</code> then you get 3 routes :</p>
<ul>
<li><code>/login</code> to connect user (<code>POST</code> request)</li>
<li><code>/logout</code> (<code>GET</code> request)</li>
<li><code>/authenticated</code> to check if current user is connected (<code>GET</code> request)</li>
</ul>
<h5>Calling <code>/login</code> with jQuery (<code>$.ajax</code>)</h5>
<pre><code>$.ajax({
  type: "POST",
  url: "login",
  data: JSON.stringify({pseudo:"admin", password:"admin"}),
  success: function(data){ console.log("success", data); },
  error: function(err){ console.log("error", err); },
  dataType: "json"
});
</code></pre>
<h5>Calling <code>/logout</code> with jQuery (<code>$.ajax</code>)</h5>
<pre><code>$.get("authenticated", function(data){ console.log(data); })

//return Object {authenticated: true} (or false) + pseudo if true (null if false)
</code></pre>
<h5>Calling <code>/authenticated</code> with jQuery (<code>$.ajax</code>)</h5>
<pre><code>$.get("logout", function(data){ console.log(data); })
</code></pre>

  </div>

  <h3>Session(request)</h3>
  <div>
    <h4>Description</h4>
<p><code>Session(req)</code> function returns a DynamicObject with properties of current session (Spark request: session()).</p>
<p><em>Remark: if session object doesn't exist, it will be created</em></p>
<h4>Parameter</h4>
<p>You have to pass the Spark request object to <code>Session()</code> function</p>
<h4>Properties of Session DynamicObject</h4>
<p>Each property of the DynamicObject is a session attribute :</p>
<ul>
<li><code>id()</code></li>
<li><code>pseudo()</code></li>
<li><code>read()</code></li>
<li><code>create()</code></li>
<li><code>update()</code></li>
<li><code>delete()</code></li>
<li><code>admin()</code></li>
</ul>

  </div>

  <h3>User()</h3>
  <div>
    <h4>Description</h4>
<p><code>User()</code> function returns a <code>m33ki.models.Model()</code> with default <code>fields(map[])</code> :</p>
<pre><code>map[
    ["pseudo", "john"]
  , ["firstName", "John"]
  , ["lastName", "Doe"]
  , ["password", null]
  , ["read", true]
  , ["create", false]
  , ["update", false]
  , ["delete", false]
  , ["admin", false]
]
</code></pre>
<h4>User Methods (+ Model methods)</h4>
<ul>
<li><code>rights(canRead, canCreate, canUpdate, canDelete)</code> : set fields values of <code>read, create, update, delete</code></li>
</ul>

  </div>

  <h3>decrypt(something, withSecurityKey)</h3>
  <div>
    <h4>Description</h4>
<p><code>decrypt(something, withSecurityKey)</code> function returns a decrypted string</p>
<h4>Parameters</h4>
<ul>
<li><code>something</code> : String to decrypt</li>
<li><code>withSecurityKey</code> : security key</li>
</ul>

  </div>

  <h3>encrypt(something, withSecurityKey)</h3>
  <div>
    <h4>Description</h4>
<p><code>encrypt(something, withSecurityKey)</code> function returns an encrypted string</p>
<h4>Parameters</h4>
<ul>
<li><code>something</code> : String to encrypt</li>
<li><code>withSecurityKey</code> : security key</li>
</ul>

  </div>







</body>
</html>
